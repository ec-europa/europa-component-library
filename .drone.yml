clone:
  git:
    image: plugins/git
    commands:
      - git init
      - git remote add origin ${DRONE_REMOTE_URL}
      - git fetch --no-tags origin master ${DRONE_COMMIT_REF}
      - git checkout -qf master
      - git branch
      - if [ "${DRONE_BUILD_EVENT}" == "pull_request" || "${DRONE_BUILD_EVENT}" == "tag" ]; then 
          git checkout -qf FETCH_HEAD;
        else 
          git reset --hard -q ${DRONE_COMMIT_SHA};
        fi
      - git status
      - git branch

pipeline:
  build:
    image: node:latest
    commands:
      - yarn install --frozen-lockfile

  coding-conventions:
    group: test
    image: node:latest
    commands:
      - yarn test:coding-conventions

  functional:
    group: test
    image: node:latest
    secrets: [ SAUCE_USERNAME, SAUCE_ACCESS_KEY ]
    commands:
      - yarn dist
      - yarn test:functional
    when:
      event: [push, tag, deployment]
