{% apply spaceless %}

{#
  Parameters:
  - "id" (string) Unique id for this item. Needed for accessibility. Generated automatically
  - "icon_path" (string) Path to the icon sprite
  - "see_all_label": (string) (default: ''): Label for the "see all" link (mobile only)
  - "item" (object)
    - "is_current" (boolean) Whether the item is currently selected
    - "label" (string) Label of the menu link
    - "external" (boolean) External link
    - "path" (string) Href of the menu link
    - "trigger_aria_label" (string) Aria label for the trigger button,
    - "link_aria_label" (string) Aria label for the parent link
    - "featured": (object) (default({}))
    - "children" (array of object) Array of sub-items
      - "external": (boolean) External link
      - "is_current" (boolean) Whether the sub-item is currently selected
      - "path" (string) Href of the sub-item link
      - "label" (string) Label of the sub-item link
#}

{% set _id = id|default('') %}
{% set _item = item|default({}) %}
{% set _menu_item_class = 'ecl-mega-menu__link' %}
{% set _menu_item_attributes = 'data-ecl-mega-menu-link' %}
{% set _menu_list_item_attributes = 'data-ecl-mega-menu-item' %}
{% set _menu_list_item_class = 'ecl-mega-menu__item' %}
{% set _icon_path = icon_path|default('') %}
{% set _featured = featured|default({}) %}
{% set _see_all = see_all|default(false) %}
{% set _sublist_class = 'ecl-mega-menu__sublist' %}
{% set _mega_class = 'ecl-mega-menu__mega' %}
{% set _see_all_label = see_all_label|default('') %}
{% set _trigger_aria_label = _item.trigger_aria_label|default('') %}
{% set _link_aria_label = _item.link_aria_label|default('') %}
{% set _icon = {} %}

{% if _item.is_current is defined %}
  {% set _menu_item_class = _menu_item_class ~ ' ecl-mega-menu__link--current' %}
  {% set _menu_list_item_class = _menu_list_item_class ~ ' ecl-mega-menu__item--current' %}
{% endif %}

{% if _item.container is defined and _item.container is not empty %}
  {% set _menu_list_item_class = _menu_list_item_class ~ ' ecl-mega-menu__item--has-container' %}
  {% set _menu_list_item_attributes = _menu_list_item_attributes ~ ' data-ecl-has-container aria-haspopup aria-expanded="false"' %}
{% endif %}

{% if _item.children is defined and _item.children is not empty and _item.children is iterable %}
  {% set _menu_list_item_attributes = _menu_list_item_attributes ~ ' data-ecl-has-children aria-haspopup aria-expanded="false"' %}
  {% set _menu_list_item_class = _menu_list_item_class ~ ' ecl-mega-menu__item--has-children' %}
  {% if _trigger_aria_label is not empty %}
    {% set _menu_list_item_attributes = _menu_list_item_attributes  ~ ' aria-label="' ~ _trigger_aria_label ~ '"' %}
  {% endif %}
  {% if _link_aria_label is not empty %}
    {% set _menu_list_item_attributes = _menu_list_item_attributes ~ ' data-ecl-parent-aria-label="' ~ _link_aria_label ~ '"' %}
  {% endif %}
{% endif %}
{% if (_item.children is defined and _item.children is not empty and _item.children is iterable) or _item.container is not empty %}
  {% set _icon = {
    name: 'corner-arrow',
    transform: 'rotate-90',
    path: _icon_path,
    size: '2xs',
  } %}
{% endif %}

{% if _item.label is not empty %}
<li class="{{ _menu_list_item_class }}" {{ _menu_list_item_attributes|raw }} id="{{ _id }}">
  {% set _sublink_class = 'ecl-mega-menu__sublink' ~ (child.is_current is defined ? ' ecl-mega-menu__sublink--current' : '') %}
  {% if _item.path is not empty %}
    {% include '@ecl/link/link.html.twig' with {
      link: {
        type: 'standalone',
        label: _item.label,
        path: _item.path,
        external: _item.external|default(false),
        icon_position: 'after',
      },
      icon: _icon,
      extra_classes: _menu_item_class,
      extra_attributes: [
        { name: _menu_item_attributes },
        { name: 'id', value: _id ~ "-link" },
      ],
    } only %}
  {% else %}
    <span class="ecl-mega-menu__item-label">{{ _item.label }}</span>
  {% endif %}
{% endif %}
{%- if _item.container is defined and _item.container is not empty %}
  <div
    class="{{ _mega_class }} ecl-mega-menu__mega-container"
    data-ecl-mega-menu-mega
  >
    <div class="ecl-mega-menu__mega-container-scrollable">
      {{ _item.container }}
    </div>
  </div>
{% endif %}
{%- if _item.children is defined and _item.children is not empty and _item.children is iterable -%}
  {% if _item.level == 2 %}
    {% set _mega_class = _mega_class ~ ' ecl-mega-menu__mega--level-2' %}
  {% endif %}
  <div
    class="{{ _mega_class }}"
    data-ecl-mega-menu-mega
  >
    <ul class="{{ _sublist_class }}">
    {% for child in _item.children %}
      {% set _subitem_attrs = 'data-ecl-mega-menu-subitem' %}
      {% set _subitem_class = 'ecl-mega-menu__subitem' %}
      {% if child.is_current is defined %}
        {% set _subitem_class = _subitem_class ~ ' ecl-mega-menu__subitem--current' %}
      {% endif %}
      {% if child.children is defined and child.children is not empty %}
        {% set _subitem_attrs = _subitem_attrs ~ ' aria-expanded="false"' %}
      {% endif %}
      <li
        class="{{ _subitem_class }}"
        {{- _subitem_attrs -}}
      >
        {% set _sublink_class = 'ecl-mega-menu__sublink' %}
        {% set _icon = {} %}
        {% if child.children is defined and child.children is not empty and _item.level|default(0) < 2 %}
          {% set _icon = {
            name: 'corner-arrow',
            transform: 'rotate-90',
            path: _icon_path,
            size: '2xs',
          } %}
        {% endif %}
        {% include '@ecl/link/link.html.twig' with {
          link: {
            type: 'standalone',
            label: child.label,
            path: child.path,
            external: child.external,
          },
          icon: _icon,
          extra_classes: _sublink_class,
        } only %}
        {% if child.children is defined and child.children is not empty %}
          {% include '@ecl/mega-menu/mega-menu-item.html.twig' with {
              see_all_label: _see_all_label,
              see_all: child.see_all|default(false),
              icon_path: _icon_path,
              featured: child.featured|default({}),
              item: {
                path: child.path, 
                children: child.children,
                level: 2,
              },           
          } only %}
        {% endif %}
      </li>
    {% endfor %}
    {% if _see_all and _see_all_label is not empty %}
    <li class="ecl-mega-menu__subitem ecl-mega-menu__see-all">
      {% include '@ecl/link/link.html.twig' with {
        link: {
          type: 'standalone',
          label: _see_all_label,
          path: _item.path,
        },
        icon: {
          path: _icon_path,
          name: 'arrow-left',
          size: 'xs',
          transform: 'rotate-180',
        },
      } only %}
    </li>
  {% endif %}
    </ul>
  {% if _featured is not empty %}
    <div
      class="ecl-mega-menu__featured"
      data-ecl-mega-menu-featured
    >
    {% if _featured.title is not empty %}
      <span class="ecl-mega-menu__featured-title">
        {{  _featured.title }}
      </span>
    {% endif %}
    {% if _featured.content is not empty %}
      <div class="ecl-mega-menu__featured-content">
        {{ _featured.content }}
      </div>
    {% endif %}
    {% if _featured.items is not empty and _featured.items is iterable %}
      <ul class="ecl-mega-menu__featured-list">
        {% for item in _featured.items %}
          <li class="ecl-mega-menu__featured-list__item">
            {% include '@ecl/link/link.html.twig' with {
              link: item|merge({ type: 'standalone' })
            } only %}
          </li>
        {% endfor %}
      </ul>
    {% endif %}
    </div>
  {% endif %}
  </div>
{% endif %}
</li>

{% endapply %}
