{% apply spaceless %}

{#
  Parameters:
  - "id" (string) Unique id for this item. Needed for accessibility. Generated automatically
  - "icon_path" (string) Path to the icon sprite
  - "see_all": (boolean) (default: false) Whether to show the "view all" link
  - "see_all_label": (string) (default: ''): Label for the "view all" link
  - "item" (object)
    - "is_current" (boolean) Whether the item links to the current page
    - "label" (string) Label of the menu link
    - "external" (boolean) External link
    - "path" (string) Href of the menu link
    - "trigger_aria_label" (string) Aria label for the trigger button,
    - "link_aria_label" (string) Aria label for the parent link
    - "featured": (object) (default({})) Featured column
        "title" (string) Title of the featured panel
        "content" (string) Content of the featured panel
        "items" (associative array) Array of items
          "path" Path or Url for the href
          "label" Label of the item
          "external" Whether the link is external
    - "container": (string) White panel to be filled at will
    - "children" (array of object) Array of sub-items
      - "external": (boolean) External link
      - "is_current" (boolean) Whether the item links to the current page
      - "path" (string) Href of the sub-item link
      - "label" (string) Label of the sub-item link
      - "trigger_aria_label" (string) Aria label for the trigger button,
      - "link_aria_label" (string) Aria label for the parent link
#}

{% set _id = id|default('') %}
{% set _item = item|default({}) %}
{% set _menu_item_class = 'ecl-mega-menu__link' %}
{% set _menu_item_attributes = 'data-ecl-mega-menu-link' %}
{% set _menu_list_item_attributes = 'data-ecl-mega-menu-item' %}
{% set _menu_list_item_class = 'ecl-mega-menu__item' %}
{% set _icon_path = icon_path|default('') %}
{% set _featured = _item.featured|default({}) %}
{% set _see_all = see_all|default(false) %}
{% set _sublist_class = 'ecl-mega-menu__sublist' %}
{% set _mega_class = 'ecl-mega-menu__mega' %}
{% set _see_all_label = see_all_label|default('') %}
{% set _icon = {} %}

{# Internal logic - Process properties #}

{% if _item.is_current is defined %}
  {% set _menu_item_class = _menu_item_class ~ ' ecl-mega-menu__link--current ecl-mega-menu__link--current-page' %}
  {% set _menu_list_item_class = _menu_list_item_class ~ ' ecl-mega-menu__item--current  ecl-mega-menu__item--current-page' %}
  {% set _menu_list_item_attributes = _menu_list_item_attributes ~ ' aria-current="page"' %}
{% endif %}

{% if _item.container is defined and _item.container is not empty %}
  {% set _menu_list_item_class = _menu_list_item_class ~ ' ecl-mega-menu__item--has-container' %}
  {% set _menu_list_item_attributes = _menu_list_item_attributes ~ ' data-ecl-has-container aria-haspopup aria-expanded="false"' %}
{% endif %}

{% if _item.children is defined and _item.children is not empty and _item.children is iterable %}
  {% set _menu_list_item_attributes = _menu_list_item_attributes ~ ' data-ecl-has-children aria-haspopup aria-expanded="false"' %}
  {% set _menu_list_item_class = _menu_list_item_class ~ ' ecl-mega-menu__item--has-children' %}
  {% if _item.trigger_aria_label is not empty %}
    {% set _menu_list_item_attributes = _menu_list_item_attributes  ~ ' aria-label="' ~ _item.trigger_aria_label ~ '"' %}
  {% endif %}
  {% if _item.link_aria_label is not empty %}
    {% set _menu_list_item_attributes = _menu_list_item_attributes ~ ' data-ecl-parent-aria-label="' ~ _item.link_aria_label ~ '"' %}
  {% endif %}
{% endif %}

{% if _item.level == 2 %}
  {% set _mega_class = _mega_class ~ ' ecl-mega-menu__mega--level-2' %}
{% endif %}

{% if (_item.children is defined and _item.children is not empty and _item.children is iterable) or _item.container is not empty %}
  {% set _icon = {
    name: 'corner-arrow',
    transform: 'rotate-90',
    path: _icon_path,
    size: '2xs',
  } %}
{% endif %}

{%- if _item.label is not empty -%}
<li class="{{ _menu_list_item_class }}" {{ _menu_list_item_attributes|raw }} id="{{ _id }}">
  {% include '@ecl/link/link.html.twig' with {
    link: {
      type: 'standalone',
      label: _item.label,
      path: _item.path,
      icon_path: icon_path,
      external: _item.external|default(false),
      icon_position: 'after',
    },
    icon: _icon,
    extra_classes: _menu_item_class,
    extra_attributes: [
      { name: _menu_item_attributes },
      { name: 'id', value: _id ~ "-link" },
    ],
  } only %}
{%- endif -%}

{# Container #}
{%- if _item.container is defined and _item.container is not empty -%}
  <div
    class="{{ _mega_class }} ecl-mega-menu__mega-container"
    data-ecl-mega-menu-mega
  >
    <div class="ecl-mega-menu__mega-container-scrollable">
      {{ _item.container }}
    </div>
  </div>
{# Children #}
{%- elseif _item.children is defined and _item.children is not empty and _item.children is iterable -%}
  <div
    class="{{ _mega_class }}"
    data-ecl-mega-menu-mega
  >
    <ul class="{{ _sublist_class }}">
    {% for child in _item.children %}
      {% set _icon = {} %}
      {% set _subitem_attrs = 'data-ecl-mega-menu-subitem' %}
      {% set _subitem_class = 'ecl-mega-menu__subitem' %}
      {% set _sublink_class = 'ecl-mega-menu__sublink' %}
      {% if child.is_current is defined %}
        {% set _subitem_class = _subitem_class ~ ' ecl-mega-menu__subitem--current ecl-mega-menu__subitem--current-page' %}
        {% set _subitem_attrs = _subitem_attrs ~ ' aria-current="page"' %}
      {% endif %}
      {% if child.children is defined and child.children is not empty %}
        {% set _subitem_attrs = _subitem_attrs ~ ' aria-expanded="false"' %}
        {% if child.trigger_aria_label %}
          {% set _subitem_attrs = _subitem_attrs ~ ' aria-label="' ~ child.trigger_aria_label ~ '"' %}
        {% endif %}
        {% if child.link_aria_label %}
          {% set _subitem_attrs = _subitem_attrs ~ ' data-ecl-parent-aria-label="' ~ child.link_aria_label ~ '"' %}
        {% endif %}
      {% endif %}
      {% if child.children is defined and child.children is not empty and _item.level|default(0) < 2 %}
        {% set _icon = {
          name: 'corner-arrow',
          transform: 'rotate-90',
          path: _icon_path,
          size: '2xs',
        } %}
      {% endif %}
      <li
        class="{{ _subitem_class }}"
        {{- _subitem_attrs|raw -}}
      >
        {% include '@ecl/link/link.html.twig' with {
          link: {
            type: 'standalone',
            label: child.label,
            path: child.path,
            external: child.external,
            icon_path: _icon_path,
          },
          icon: _icon,
          extra_classes: _sublink_class,
        } only %}

        {# Children, 2nd level #}
        {%- if child.children is defined and child.children is not empty -%}
          {% include '@ecl/mega-menu/mega-menu-item.html.twig' with {
              see_all_label: _see_all_label,
              see_all: child.see_all|default(false),
              icon_path: _icon_path,
              item: {
                is_current: child.is_current|default(false),
                path: child.path, 
                children: child.children,
                level: 2,
                featured: child.featured|default({}),
                trigger_aria_label: child.trigger_aria_label|default(''),
                link_aria_label: child.link_aria_label|default(''),
              },           
          } only %}
        {%- endif -%}
      </li>
    {% endfor %}
    {%- if _see_all and _see_all_label is not empty -%}
      <li class="ecl-mega-menu__subitem ecl-mega-menu__see-all">
        {% include '@ecl/link/link.html.twig' with {
          link: {
            type: 'standalone',
            label: _see_all_label,
            path: _item.path,
          },
          icon: {
            path: _icon_path,
            name: 'arrow-left',
            size: 'xs',
            transform: 'rotate-180',
          },
        } only %}
      </li>
    {%- endif -%}
    </ul>

  {# Featured #}
  {% if _featured is not empty %}
    <div
      class="ecl-mega-menu__featured"
      data-ecl-mega-menu-featured
    >
    {% if _featured.title is not empty %}
      <span class="ecl-mega-menu__featured-title">{{  _featured.title }}</span>
    {% endif %}
      <div class="ecl-mega-menu__featured-scrollable">
      {%- if _featured.content is not empty -%}
        <div class="ecl-mega-menu__featured-content">{{ _featured.content }}</div>
      {%- endif -%}
      {%- if _featured.items is not empty and _featured.items is iterable -%}
        <ul class="ecl-mega-menu__featured-list">
          {% for item in _featured.items %}
            <li class="ecl-mega-menu__featured-list__item">
              {% include '@ecl/link/link.html.twig' with {
                link: item|merge({ type: 'standalone', icon_path: _icon_path })
              } only %}
            </li>
          {% endfor %}
        </ul>
      {%- endif -%}
      </div>
    </div>
  {% endif %}
  </div>
{% endif %}
</li>

{% endapply %}
